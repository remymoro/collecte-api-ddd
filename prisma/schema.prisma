generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

/////////////////////////////
// ENUMS
/////////////////////////////

enum EntryStatus {
  EN_COURS
  VALIDEE
}

enum UserRole {
  ADMIN
  BENEVOLE
}

enum CampaignStatus {
  PLANIFIEE
  EN_COURS
  TERMINEE
  CLOTUREE
  ANNULEE
}

enum StoreStatus {
  DISPONIBLE
  INDISPONIBLE
  FERME
}

enum CampaignStoreAuthorizationStatus {
  ACTIVE
  INACTIVE
}

/////////////////////////////
// CORE ENTITIES
/////////////////////////////

model Campaign {
  id   String @id @default(uuid())
  name String
  year Int    @unique

  startDate          DateTime
  endDate            DateTime
  gracePeriodEndDate DateTime

  status CampaignStatus @default(PLANIFIEE)

  objectives  String?
  description String?

  createdBy String
  closedBy  String?
  closedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator User  @relation("CampaignCreator", fields: [createdBy], references: [id])
  closer  User? @relation("CampaignCloser", fields: [closedBy], references: [id])

  authorizations CampaignStoreAuthorization[]

  // ✅ AJOUT ICI
  collecteEntries CollecteEntry[]

  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model Center {
  id         String  @id @default(uuid())
  name       String
  address    String
  city       String
  postalCode String
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())

  users   User[]
  stores  Store[]
  entries CollecteEntry[]

  @@index([city])
  @@index([isActive])
}

model Store {
  id          String  @id @default(uuid())
  name        String
  address     String
  city        String
  postalCode  String
  phone       String?
  contactName String?

  status StoreStatus @default(DISPONIBLE)
  images Json        @default("[]")

  // Audit métier
  statusChangedAt DateTime?
  statusChangedBy String?
  statusReason    String?

  centerId String
  center   Center @relation(fields: [centerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorizations CampaignStoreAuthorization[]

  // ✅ AJOUT ICI
  collecteEntries CollecteEntry[]

  @@index([centerId])
  @@index([city])
  @@index([status])
}

model CampaignStoreAuthorization {
  id         String @id @default(uuid())
  campaignId String
  storeId    String

  status CampaignStoreAuthorizationStatus

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([campaignId, storeId])
  @@index([campaignId])
  @@index([storeId])
}

/////////////////////////////
// SAISIES TERRAIN
/////////////////////////////

model CollecteEntry {
  id     String      @id @default(uuid())
  status EntryStatus @default(EN_COURS)

  // Cache (pas source de vérité)
  totalKg Decimal @default(0) @db.Decimal(10, 3)

  campaignId String
  storeId    String
  centerId   String

  createdBy   String
  validatedBy String?

  createdAt   DateTime  @default(now())
  validatedAt DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id])
  store    Store    @relation(fields: [storeId], references: [id])
  center   Center   @relation(fields: [centerId], references: [id])

  creator   User  @relation("EntryCreator", fields: [createdBy], references: [id])
  validator User? @relation("EntryValidator", fields: [validatedBy], references: [id])

  items CollecteEntryItem[]

  @@index([campaignId])
  @@index([storeId])
  @@index([centerId])
  @@index([status])
}

model CollecteEntryItem {
  id         String  @id @default(uuid())
  entryId    String
  productRef String
  family     String
  subFamily  String?
  weightKg   Decimal @db.Decimal(10, 3)

  entry CollecteEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@index([productRef])
}

/////////////////////////////
// PRODUITS
/////////////////////////////

model Product {
  reference String  @id
  family    String
  subFamily String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/////////////////////////////
// UTILISATEURS
/////////////////////////////

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  role         UserRole

  centerId String?
  center   Center? @relation(fields: [centerId], references: [id])

  createdAt DateTime @default(now())

  createdCampaigns Campaign[] @relation("CampaignCreator")
  closedCampaigns  Campaign[] @relation("CampaignCloser")

  createdEntries   CollecteEntry[] @relation("EntryCreator")
  validatedEntries CollecteEntry[] @relation("EntryValidator")

  @@index([role])
  @@index([centerId])
}
